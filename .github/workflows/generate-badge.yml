name: Update Profile PR Stats

on:
  schedule:
    - cron: '0 16 * * *' # 每日北京时间晚上12点更新 (UTC+8，所以是UTC 16:00)
  push:
    branches:
      - main
  workflow_dispatch: # 允许手动触发

jobs:
  update-profile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Profile Repo
        uses: actions/checkout@v4
        with:
          repository: lxKylin/lxKylin
          token: ${{ secrets.DATA_CARD_TOKEN }}

      - name: Generate PR Statistics
        id: stats
        uses: lxKylin/repo-contribution-count-action@v1.1.0
        with:
          pr-links: |
            https://github.com/vitejs/docs-cn/commits?author=lxKylin
            https://github.com/vitest-dev/docs-cn/commits?author=lxKylin
            https://github.com/vitejs/docs-cn/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/element-plus/element-plus/commits?author=lxKylin
            https://github.com/baidu/amis/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/web-infra-dev/rsbuild/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/vueComponent/ant-design-vue/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/ant-design/ant-design-web3/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/arco-design/arco-design-vue/commits?author=lxKylin
            https://github.com/bytedance/flowgram.ai/commits?author=lxKylin
          github-token: ${{ secrets.DATA_CARD_TOKEN }}
          badge-style: 'flat'
          output-format: 'html'

      - name: Update Profile README
        run: |
          echo "开始更新 README.md..."

          # 检查当前目录内容
          echo "当前目录内容:"
          ls -la

          # 检查 README.md 是否存在标记
          echo "检查 README.md 中的标记..."
          grep -n "PR_STATS" README.md || echo "未找到标记"

          # 创建临时文件包含新的内容
          cat > temp_stats.md << 'EOF'
          <!-- PR_STATS_START -->
          ### 我的开源贡献（由 [repo-contribution-count-action](https://github.com/lxKylin/repo-contribution-count-action) 生成）

          ${{ steps.stats.outputs.badges }}

          > ${{ steps.stats.outputs.summary }}

          <!-- PR_STATS_END -->
          EOF

          echo "临时文件内容:"
          cat temp_stats.md

          # 使用 awk 替换 README.md 中指定部分的内容
          awk '
          BEGIN { in_section = 0; found_start = 0 }
          /<!-- PR_STATS_START -->/ {
            if (!found_start) {
              found_start = 1
              in_section = 1
              while ((getline line < "temp_stats.md") > 0) {
                print line
              }
              close("temp_stats.md")
              next
            }
          }
          /<!-- PR_STATS_END -->/ {
            if (in_section) {
              in_section = 0
              next
            }
          }
          !in_section { print }
          ' README.md > README_new.md

          # 检查文件是否生成成功
          if [ -f README_new.md ]; then
            echo "README_new.md 生成成功"
            echo "文件大小对比:"
            wc -l README.md README_new.md
            mv README_new.md README.md
            echo "README.md 更新完成"
          else
            echo "ERROR: README_new.md 生成失败"
            exit 1
          fi

          # 清理临时文件
          rm -f temp_stats.md

          # 显示更新后的文件内容（前20行）
          echo "更新后的 README.md 前20行:"
          head -20 README.md

      - name: Commit and Push
        run: |
          echo "检查文件更改..."
          git status

          # 检查是否有更改
          if git diff --quiet README.md; then
            echo "README.md 没有变化，跳过提交"
          else
            echo "README.md 有更改，准备提交..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add README.md
            git commit -m "refactor: 更新 PR 统计数据 $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "提交完成！"
          fi
