name: Update Profile PR Stats

# on:
#   schedule:
#     - cron: '0 6 * * 1' # 每周一早上 6 点更新
#   workflow_dispatch:
# 触发条件：在 push 到 main 分支后
on:
  push:
    branches:
      - main

jobs:
  update-profile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Profile Repo
        uses: actions/checkout@v4
        with:
          repository: lxKylin/lxKylin
          token: ${{ secrets.DATA_CARD_TOKEN }}

      - name: Generate PR Statistics
        id: stats
        uses: lxKylin/repo-contribution-count-action@main
        with:
          pr-links: |
            https://github.com/vitejs/docs-cn/commits?author=lxKylin
            https://github.com/vitest-dev/docs-cn/commits?author=lxKylin
            https://github.com/vitejs/docs-cn/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/element-plus/element-plus/commits?author=lxKylin
          github-token: ${{ secrets.DATA_CARD_TOKEN }}
          badge-style: 'for-the-badge'
          output-format: 'markdown'

      - name: Update Profile README
        run: |
          # 创建临时文件包含新的内容
          cat > temp_stats.md << 'EOF'
          <!-- PR_STATS_START -->
          ## 🚀 我的开源贡献

          ${{ steps.stats.outputs.badges }}

          > ${{ steps.stats.outputs.summary }}

          ### Hi there 👋
          Welcome to my Github
          <hr>

          <a href="https://github.com/element-plus/element-plus/commits?author=lxKylin">
          <img align="center" src="https://raw.githubusercontent.com/lxKylin/lxKylin/svg/element-plus.svg" alt="" />
          </a>
          <a href="https://github.com/vitest-dev/docs-cn/commits?author=lxKylin">
          <img align="center" src="https://raw.githubusercontent.com/lxKylin/lxKylin/svg/docs-cn.svg" alt="" />
          </a>
          <a href="https://github.com/ant-design/ant-design/commits?author=lxKylin">
          <img align="center" src="https://raw.githubusercontent.com/lxKylin/lxKylin/svg/ant-design.svg" alt="" />
          </a>
          <a href="https://github.com/ant-design/ant-design-web3/commits?author=lxKylin">
          <img align="center" src="https://raw.githubusercontent.com/lxKylin/lxKylin/svg/ant-design-web3.svg" alt="" />
          </a>

          <table>
            <tr>
              <td><img align="center" src="https://github-readme-stats.vercel.app/api?username=lxKylin&show_icons=true&hide_border=true" alt="" /></td>
              <td><img align="center" src="https://github-readme-stats.vercel.app/api/top-langs/?username=lxKylin&layout=compact&hide_border=true" alt="" /></td>
            </tr>
            <tr>
              <td><img align="center" src="./image/juejin.svg" alt="" /></td>
            </tr>
          </table>

          *最后更新: $(date "+%Y-%m-%d %H:%M:%S")*
          <!-- PR_STATS_END -->
          EOF

          # 使用 awk 替换 README.md 中指定部分的内容
          awk '
          BEGIN { in_section = 0; found_start = 0 }
          /<!-- PR_STATS_START -->/ {
            if (!found_start) {
              found_start = 1
              in_section = 1
              while ((getline line < "temp_stats.md") > 0) {
                print line
              }
              close("temp_stats.md")
              next
            }
          }
          /<!-- PR_STATS_END -->/ {
            if (in_section) {
              in_section = 0
              next
            }
          }
          !in_section { print }
          ' README.md > README_new.md && mv README_new.md README.md

          # 清理临时文件
          rm -f temp_stats.md

      - name: Commit and Push
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "📊 更新 PR 统计数据" || exit 0
          git push
