name: Update Profile PR Stats

# on:
#   schedule:
#     - cron: '0 6 * * 1' # æ¯å‘¨ä¸€æ—©ä¸Š 6 ç‚¹æ›´æ–°
#   workflow_dispatch:
# è§¦å‘æ¡ä»¶ï¼šåœ¨ push åˆ° main åˆ†æ”¯å
on:
  push:
    branches:
      - main

jobs:
  update-profile:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Profile Repo
        uses: actions/checkout@v4
        with:
          repository: lxKylin/lxKylin
          token: ${{ secrets.DATA_CARD_TOKEN }}

      - name: Generate PR Statistics
        id: stats
        uses: lxKylin/repo-contribution-count-action@main
        with:
          pr-links: |
            https://github.com/vitejs/docs-cn/commits?author=lxKylin
            https://github.com/vitest-dev/docs-cn/commits?author=lxKylin
            https://github.com/vitejs/docs-cn/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/element-plus/element-plus/commits?author=lxKylin
            https://github.com/baidu/amis/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/web-infra-dev/rsbuild/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/vueComponent/ant-design-vue/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/ant-design/ant-design-web3/pulls?q=is%3Apr+author%3AlxKylin
            https://github.com/arco-design/arco-design-vue/commits?author=lxKylin
          github-token: ${{ secrets.DATA_CARD_TOKEN }}
          badge-style: 'flat'
          output-format: 'html'

      - name: Update Profile README
        run: |
          echo "å¼€å§‹æ›´æ–° README.md..."

          # æ£€æŸ¥å½“å‰ç›®å½•å†…å®¹
          echo "å½“å‰ç›®å½•å†…å®¹:"
          ls -la

          # æ£€æŸ¥ README.md æ˜¯å¦å­˜åœ¨æ ‡è®°
          echo "æ£€æŸ¥ README.md ä¸­çš„æ ‡è®°..."
          grep -n "PR_STATS" README.md || echo "æœªæ‰¾åˆ°æ ‡è®°"

          # åˆ›å»ºä¸´æ—¶æ–‡ä»¶åŒ…å«æ–°çš„å†…å®¹
          cat > temp_stats.md << 'EOF'
          <!-- PR_STATS_START -->
          ## ğŸš€ æˆ‘çš„å¼€æºè´¡çŒ®

          ${{ steps.stats.outputs.badges }}

          > ${{ steps.stats.outputs.summary }}

          <!-- PR_STATS_END -->
          EOF

          echo "ä¸´æ—¶æ–‡ä»¶å†…å®¹:"
          cat temp_stats.md

          # ä½¿ç”¨ awk æ›¿æ¢ README.md ä¸­æŒ‡å®šéƒ¨åˆ†çš„å†…å®¹
          awk '
          BEGIN { in_section = 0; found_start = 0 }
          /<!-- PR_STATS_START -->/ {
            if (!found_start) {
              found_start = 1
              in_section = 1
              while ((getline line < "temp_stats.md") > 0) {
                print line
              }
              close("temp_stats.md")
              next
            }
          }
          /<!-- PR_STATS_END -->/ {
            if (in_section) {
              in_section = 0
              next
            }
          }
          !in_section { print }
          ' README.md > README_new.md

          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦ç”ŸæˆæˆåŠŸ
          if [ -f README_new.md ]; then
            echo "README_new.md ç”ŸæˆæˆåŠŸ"
            echo "æ–‡ä»¶å¤§å°å¯¹æ¯”:"
            wc -l README.md README_new.md
            mv README_new.md README.md
            echo "README.md æ›´æ–°å®Œæˆ"
          else
            echo "ERROR: README_new.md ç”Ÿæˆå¤±è´¥"
            exit 1
          fi

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f temp_stats.md

          # æ˜¾ç¤ºæ›´æ–°åçš„æ–‡ä»¶å†…å®¹ï¼ˆå‰20è¡Œï¼‰
          echo "æ›´æ–°åçš„ README.md å‰20è¡Œ:"
          head -20 README.md

      - name: Commit and Push
        run: |
          echo "æ£€æŸ¥æ–‡ä»¶æ›´æ”¹..."
          git status

          # æ£€æŸ¥æ˜¯å¦æœ‰æ›´æ”¹
          if git diff --quiet README.md; then
            echo "README.md æ²¡æœ‰å˜åŒ–ï¼Œè·³è¿‡æäº¤"
          else
            echo "README.md æœ‰æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
            git config --local user.email "action@github.com"
            git config --local user.name "GitHub Action"
            git add README.md
            git commit -m "ğŸ“Š æ›´æ–° PR ç»Ÿè®¡æ•°æ® $(date '+%Y-%m-%d %H:%M:%S')"
            git push
            echo "æäº¤å®Œæˆï¼"
          fi
